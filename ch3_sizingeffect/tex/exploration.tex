\section{Exploration of Energy Storage Sizing} \label{sec:c3_exploration}

% The sizing method finds the suitable energy harvester size that achieves a target forward progress and explores the energy storage sizing effect (\sref{subsec:harvstor}), with a trade-off in forward progress, capacitor volume, and interruption periods (\sref{subsec:tradeoff}).

In this section, we configure the reactive IPS model presented in \sref{sec:c3_model} to approximate a real IPS platform, and then present an exploration of the relationship between \nm{\alpha}{exe} and $C$ with respect to supply current \nm{I}{harv} and volatile state size.

\subsection{Model Configuration}

We configured the model with an empirical capacitor model and experimentally measured load characteristics. 

\subsubsection{Energy Storage}

The energy storage is represented as an ideal capacitor with empirically defined leakage current. 
Its terminal voltage is directly applied to the load, so is modelled as:
\begin{equation}
  C \frac{d\nmm{V}{cc}}{dt} = \nmm{I}{harv} - \nmm{I}{load} - \nmm{I}{leak}
\end{equation}
where \nm{I}{load} is the current consumption of the load. 
In this exploration, we refer to the empirical \nm{I}{leak} of AVX TAJ low-profile series tantalum capacitors~\cite{tancap1}, which depends on capacitance $C$, rated voltage \nm{V}{rated}, and terminal voltage \nm{V}{cc}~\cite{avxleakage}:
\begin{equation}
    % aluminium 
%   \nmm{I}{leak} = max\{0.03 C \nmm{V}{rated}, \quad 4 \times 10^{-6}\}    \quad (A)
    % tantalum
    \nmm{I}{leak} = 0.01 \lambda C \nmm{V}{rated} \quad (A)
\end{equation}
where $\lambda$ denotes the ratio of the actual current leakage at \nm{V}{cc} to the current leakage at \nm{V}{rated}, and $\lambda$ is approximated as: 
\begin{equation}
    \lambda = 0.05 \times 20^{\frac{\nmm{V}{cc}}{\nmm{V}{rated}}}
\end{equation}
We assume a typical load of $<$ \SI{4.0}{\volt} so, to minimise leakage, we select a device with $\nmm{V}{rated} =$ \SI{10}{\volt} so as to operate between 25-40\% of its rated voltage~\cite{avxleakage}. 

% Here, \nm{V}{cc} affects both the energy harvester and the load. On the harvester side, \nm{V}{cc} is the operating voltage of PV cells, which has an effect on the harvested current $I_{harvest}$. On the load side, \nm{V}{cc} is the supply voltage, which determines when the load wakes up or powers off (affecting \nm{I}{load}). Hence, the energy storage, the energy harvester, and the load impact on each other through \nm{V}{cc}, $I_{harvest}$, and \nm{I}{load}. 

\subsubsection{Intermittent Computing Load} \label{ssubsec:loadconfig}

We configured the load with experimentally measured current draws and time overheads.
We only consider computational loads in this study, as handling of peripherals in intermittent systems is still an ongoing research topic~\cite{rodriguez2018restop, Maeng:2019:SPI:3314221.3314613}. 

We implemented and parameterised a reactive IPS~\cite{balsamo2015hibernus} on a TI MSP430FR6989-based development board. 
The load parameters were profiled with the MCU running a Dijkstra path finding algorithm with \SI{1696}{\byte} RAM usage at \SI{8}{\mega\hertz}. 
The supply voltage monitoring circuits use the MCU's internal comparator and an external \SI{3}{\mega\ohm} voltage divider. 
The restore and save voltage thresholds are set as \nm{V}{r} = \SI{2.4}{\volt} and \nm{V}{s} = \SI{2.1}{\volt} respectively. 
The MCU shutdown voltage \nm{V}{off} is \SI{1.8}{\volt}. 

The measured current draws and time overheads are listed in \tref{tab:load}.
The current draw was profiled with experimental measurements at a range of supply voltages. 
The variation of \nm{I}{lpm} between \nm{V}{off} (\SI{1.8}{\volt}) and \nm{V}{r} (\SI{2.4}{\volt}) is 2\%, and for \nm{I}{exe} between \nm{V}{s} (\SI{2.1}{\volt}) and \SI{3.3}{\volt} is 1.5\%. 
\nm{I}{exe} also has a run-time variation of 2.8\% due to a variable memory access rate. 
As these variations of \nm{I}{exe} and \nm{I}{lpm} in their effecting voltage range are minor, we therefore omit the variations and use the mean of \nm{I}{exe} and \nm{I}{lpm} in the model. 
\nm{I}{r} and \nm{I}{s} are measured at \nm{V}{r} and \nm{V}{s} respectively. 

Given the voltage thresholds and the current consumption, the minimum energy storage capacitance is \SI{6.2}{\micro\farad}. 
This guarantees that a save and restore operation can complete even if the incoming supply current drops instantaneously to zero. 
Moreover, the model parameters in \tref{tab:load} are given as an example, and can be changed for different load characteristics. 
For example, \nm{T}{r} and \nm{T}{s} can be tuned for different volatile state sizes.

\begin{table}
    \renewcommand{\arraystretch}{1.2}
    \centering
    \begin{tabular}{|c|c|}
    \hline
    \textbf{Parameter} & \textbf{Value}\\
    \hline
    \nm{I}{exe} & \SI{887}{\micro\ampere}\\
    \nm{I}{lpm} & \SI{26}{\micro\ampere}\\
    \nm{I}{r} & \SI{971}{\micro\ampere}\\
    \nm{I}{s} & \SI{811}{\micro\ampere}\\
    \nm{T}{r} & \SI{1.903}{\milli\second}\\
    \nm{T}{s} & \SI{1.880}{\milli\second}\\
    % \multicolumn{2}{c}{Measured Parameters}\\
    % \hline
    % $I_{exe}, I_{R}, I_{S}$ & 0.87 mA\\
    % \nm{I}{lpm} & 0.40 mA\\
    % \nm{T}{r} & 2.298 ms\\
    % \nm{T}{s} & 2.274 ms\\
    % \hline
    % \multicolumn{2}{c}{Simulation Parameters}\\
    % \hline
    % $I_{exe}, I_{R}, I_{S}$ & 1.00 mA\\
    % \nm{I}{lpm} & 0.01 mA\\
    \hline
    \end{tabular}
    \caption{Profiled MCU parameters.}
    \label{tab:load}
\end{table}



\subsection{Sizing Energy Storage to Improve Forward Progress} \label{subsec:sizees}

% Message/Summary, How, Results. 

\subsubsection{Impact of Supply Current}

\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{ch3_sizingeffect/figures/StorCCur6Fig} 
    \caption{Forward progress against energy storage capacitance at different levels of constant supply current. Error bars around \nm{C}{$\alpha$\_max} denote the impact of typical $\pm$20\% capacitance tolerance. The \SIrange{30}{150}{\micro\farad} range is omitted as forward progress in that range increases monotonically. }
    \label{fig:fpwconstcurr}
\end{figure}

Increasing energy storage capacitance beyond the minimum one can improve forward progress by reducing the frequency of power interruptions, but this improvement may be offset by increased leakage. 
\fref{fig:fpwconstcurr} shows the relationship between forward progress and energy storage capacitance for a range of constant supply currents. 
In this section, we denote the capacitance that leads to the maximum forward progress \nm{\alpha}{exe} as \nm{C}{$\alpha$\_max}. 
\nm{C}{$\alpha$\_max} for each current value is also shown in \fref{fig:fpwconstcurr}.

% some more explanation about details in this graph
The minimum capacitance (dashed line in \fref{fig:fpwconstcurr}) is calculated to deliver correct operation even if the supply current instantaneously drops to zero. 
If it does not drop to zero, this means that correct operation could have continued even with a smaller capacitance given that the current supply keeps providing energy during execution, though designing a system in this way would be inadvisable owing to unpredictability of the supply. 
This property is illustrated in \fref{fig:fpwconstcurr}, in the area on the left of the dashed line. 
It may be observed that, for each of the current values, there is a sudden drop-off towards zero forward progress. 
This illustrates the hazard of setting the capacitance too small: the stored energy is too low to allow a restore and save to be undertaken.
The reason for this step change rather than a continuous change is that the implemented IPS only performs one restore operation in the first execution cycle after a reboot and enters a low-power mode with volatile state retained after a save operation. 
Hence the energy used for restoring state is then used for effective execution in the following operating cycles as long as the supply voltage recovers to the restore threshold without a power interruption.
% If the volatile state is not retained in low-power mode (i.e. necessary to restore every operating cycle) or the supply only lasts for a limited period, 
 
Typically, commercially-available capacitors have a $\pm$20\% tolerance. 
The effect of this variation on maximum forward progress is shown to be negligible ($<$ 0.23\%) in \fref{fig:fpwconstcurr}. 
However, it must be pointed out that the effect would be much more pronounced if operating at the minimum capacitance as the variation of forward progress is larger with smaller capacitance values. 
Thus, it is recommended that a tolerance is considered when designing IPSs with minimum capacitance.

\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{ch3_sizingeffect/figures/StorCCurMax4Fig}
    \caption{Maximum forward progress improvement by sizing energy storage given a spectrum of supply current (normalised by the minimum capacitance case), with the corresponding capacitance for maximum and sub-maximum (95\% of maximum) forward progress improvement. }
    \label{fig:maxfwp}
\end{figure}

\fref{fig:maxfwp} shows that an improvement in forward progress of up to 65\%  can be achieved when using \nm{C}{$\alpha$\_max} instead of the minimum. 
However, it may not be desirable to set the capacitance solely for maximising forward progress, because there are often trade-offs with other factors including increased interruption periods and dimensions (later explored in \sref{subsec:tradeoff}).
In real-world energy source conditions, the supply current varies across this spectrum, and hence leads to an overall progress improvement based on its supply distribution. 
This improvement exists only when the device operates in the \textit{Intermittent} mode, since the device keeps either inactive in the \textit{Off} mode or active in the \textit{On} mode without the need for restoring and saving state. 
Correspondingly, \nm{C}{$\alpha$\_max} is also plotted against supply current. 
% This optimal capacity exists because of the side effect of capacitor leakage; without capacitor leakage effect, the forward progress would keep approaching the ideal case (as explained in \sref{subsec:formulation}). 
While a large improvement can be delivered with \nm{C}{$\alpha$\_max}, as shown in \fref{fig:maxfwp}, 95\% of this gain can still be obtained with significantly smaller capacitances (mean 31\% of \nm{C}{$\alpha$\_max}).
For example, reducing from \SI{325}{\micro\farad} to \SI{90}{\micro\farad} gives 95\% of the maximum improvement with a \SI{0.5}{\milli\ampere} supply. 

\subsubsection{Impact of Volatile State Size}

The size of volatile state differs across applications with different amounts of RAM usage, and hence incurs varying time and energy overheads for restore and save operations. 
We measured time overheads of restore and save operations in the minimum case (64B register data and a 160B stack) and the maximum case (64B register data and a full 2048B RAM) respectively as shown in \tref{tab:ramscale}. 
As these time overheads are expected to be linear to the state size~\cite{sliper2019efficient}, the model can be tuned for various volatile state sizes by linearly scaling the profiled values. 

\begin{table}
    \renewcommand{\arraystretch}{1.2}
    \centering
    \begin{tabular}{|c|cc|}
        \hline
        \textbf{State Size} & \multirow{2}{*}{\textbf{Restore Time}} & \multirow{2}{*}{\textbf{Save Time}}\\
        \textbf{(Registers + SRAM)} & & \\
        \hline
        64B + 160B (lower bound) & \SI{232}{\micro\second} & \SI{208}{\micro\second}\\
        % 64B registers + 160B stack
        64B + 2048B (upper bound) & \SI{2.298}{\milli\second} & \SI{2.274}{\milli\second} \\
        % 64B registers + 2048B RAM
        \hline
    \end{tabular}
    \caption{Linear scaling range of volatile state size and restore/save time overheads.}
    \label{tab:ramscale}
\end{table}

An example of this is plotted in \fref{fig:ram}. 
The forward progress improvement by sizing energy storage increases with the volatile state size, and \nm{C}{$\alpha$\_max} grows accordingly. 
The improvement becomes insignificant when the volatile state size is small because the restore and save overheads are already negligible. 
For example, when the workload uses the least volatile state (the leftmost point), the maximum progress improvement is only 3.6\% although the restore and save overheads are reduced by 93\%. 
% This indicates the more efficiently IPSs save/restore, the more useless this work is :p 

\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{ch3_sizingeffect/figures/RSTORAM3Fig}
    \caption{Impact of RAM usage (linear to restore/save overheads) on sizing energy storage with \SI{0.4}{\milli\ampere} current supply. Improvement and reduction are normalised by the minimum capacitance case. }
    \label{fig:ram}
\end{figure}

Where the size of the volatile state may vary at run time, a different capacitor size within the range \SIrange{108}{355}{\micro\farad} may have been recommended (\fref{fig:ram}). 
However, as can be seen from \fref{fig:fpwconstcurr}, there is a minimal difference in forward progress across this range. 
In the worst case, a 2.7\% reduction results from setting \nm{C}{$\alpha$\_max} for the minimum state size, while running with the largest state size.
